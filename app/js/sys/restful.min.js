/*!
* Restful.js - RESTful Level 3 Client API
* Copyright 2022-2023 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function u(n,t,i,r){return{error:{errors:[{id:"00000000-0000-0000-0000-000000000001",reason:i,message:r.message||r}],code:n,message:t}}}var i=typeof $app=="undefined"?null:$app,e=window,t={},f="",n,r;(i||(e.$app=i={}),r=i.restful,!r||r._unresolved)&&(r=i.restful=function(e){var c,l,v,a,b,y,p,s,h,o,w;if(e||(e={url:null,method:"GET",body:null}),c=e.config,l=e.query,t=c||t,!c||(n=c.baseUrl||n,Object.keys(e).length!==1)){if(!n&&(n=typeof __baseUrl=="undefined"?null:__baseUrl,!n))for(v=document.getElementsByTagName("script"),a=0;a<v.length;a++)if(b=v[a],y=(b.getAttribute("src")||"").match(/^(.+?)(\/v\d\/js|\/js\/sys)\/restful.*?\.js/),y){n=y[1];p=n.match(/^(\w+\:\/\/(.+?))\//);f=p?p[1]:n;break}if(s=e.token||(e.token!==!1&&t.token?typeof t.token=="function"?t.token():t.token:null),h=typeof s=="string"?s:s&&typeof s=="object"?s.access_token:null,!h&&i.AccountManager&&(s=i.AccountManager.current(),s&&(h=s.access_token)),e.url&&e.url.href&&(e.method=e.url.method,e.url=e.url.href),o=e.url||(n?"~/v2":"/v2"),n&&(n.match(/\/$/)||(n+="/"),o.match(/^~\//)?o=n+o.substring(2):o.match(/^(http|\/)/)?o.match(/^\//)&&(o=f+o):o=n+o),l){o=[o];for(w in l)o.push(o.length===1?o[0].match(/\?|#/)?"&":"?":"&",w,"=",encodeURIComponent(l[w]));o=o.join("")}return new Promise((n,f)=>{function vt(t){e.token=t;r(e).then(t=>{n&&n(t)}).catch(w)}function w(n){f&&f(n.error||n)}var a=new Headers,d=e.method||"GET",c=e.hypermedia,l=e.body,ct=l&&l instanceof FormData,g,ft,b,lt,nt,v,p,tt,et,ot,it,at,st,k,ht,y,rt,ut;if(h&&a.append("Authorization","Bearer "+h),a.append("Accept",e.accept||"application/json"),d==="GET"||ct||a.append("Content-Type",e.contentType||"application/json"),e.headers)for(ft in e.headers)a.append(ft,e.headers[ft]);if(e.schema&&(g="true"),e.schemaOnly&&(g="only"),g&&a.append("X-Restful-Schema",g),c===!1&&a.append("X-Restful-Hypermedia","false"),typeof c=="string"&&c.length&&(b=c.match(/^(.+?)(\s*(>>)\s*(.*))?$/),b&&(c={name:b[1],transition:!!b[3],next:b[4]},c.transition))){for(v in["body","query","headers","files"])delete e[v];lt=new RegExp(RegExp("^"+c.name+"\\s*>>"));for(v in e)if(v.match(lt)){if(nt=e[v],nt)for(v in nt)e[v]=nt[v];break}}if(y=e.etag,l&&typeof l=="object"&&!ct){y===!0&&(tt=l._links,y=tt&&tt.self&&tt.self.etag);for(et in l)ot=l[et],ot instanceof Blob&&(p||(p=[]),p.push({f:et,v:ot}));p&&(p.forEach(n=>delete l[n.f]),a.delete("Content-Type"));l=JSON.stringify(l)}typeof y=="string"&&a.append("If-Match",y);p&&(it=new FormData,it.set("",new Blob([l],{type:"application/json"}),""),p.forEach(n=>it.set(n.f,n.v,n.v.name||"")),l=it);at={method:d,headers:a,body:d==="GET"?null:l,redirect:"follow"};ut=e.dataType==="response";fetch(o,at).then(function(n){return st=n.status,k=n.headers.get("Content-Type")||"",ht=n.headers.get("Content-Disposition"),y=n.headers.get("ETag"),rt=!ut&&st!==401&&k.match(/^(application\/(json|x-yaml|xml)|text\/(yaml|x-yaml|xml))/),ut?n:rt?n.text():n.arrayBuffer()}).then(f=>{var h,l,a;if(st===401)s&&s.refresh_token?i.refreshUserToken?i.refreshUserToken(s,()=>{vt(i.AccountManager.current())}):r({url:"/oauth2/v2/token",method:"POST",body:{grant_type:"refresh_token",client_id:t.clientId,refresh_token:s.refresh_token},token:!1}).then(n=>{var i,r;if(typeof t.token=="function"){if(i=t.token(),typeof i=="object")for(r in n)i[r]=n[r];t.token(i)}e.token=n;vt(n)}).catch(w):w(u(401,"Unauthorized","access_denied","Invalid acces token or API key is specified."));else if(n)if(ut)n(f);else if(rt&&k.match(/^application\/json/))if(f!=null&&f.length||(f="{}"),f=JSON.parse(f),f&&f.error)f.error._schema=f._schema,w(f.error);else{if(y&&f._links&&(h=f._links.self,h&&(h.etag=y)),c&&c.name)if(f=f._links?f._links[c.name]:null,f==null)w(u(400,"Bad Request","invalid_hypermedia","Hypermedia '"+c[1]+"' not found in "+d+" "+o+" response."));else if(c.transition){e.url=f;e.hypermedia=c.next;r(e).then(t=>{n(t)}).catch(w);return}c===!0&&(f=f._links||{});n(f||{})}else rt||(l="file."+(k.split(";")[0]||"/dat").split(/\//)[1],ht&&(a=ht.match(/filename=(.+?)(;|$)/),a&&(l=a[1])),f=new Blob([f],{type:k}),f.name=l),n(f)}).catch(n=>{w(u(400,"Bad Request","error",n))})})}})})();